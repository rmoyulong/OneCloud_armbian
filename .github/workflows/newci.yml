name: ç©å®¢äº‘armbainæœ€æ–°ç‰ˆ

on:
  #å¯¹åº”çš„æ˜¯ UTC æ—¶é—´ï¼Œéœ€è¦è½¬æ¢ï¼Œ0 ä»£è¡¨åŒ—äº¬æ—¶é—´8ç‚¹ï¼Œæ¯ä¸ªæœˆ1æ—¥/15æ—¥12ç‚¹ç¼–è¯‘ä¸€æ¬¡
  #å…³é—­åˆ™æ‰‹åŠ¨ç¼–è¯‘
  workflow_dispatch:
    inputs:
      BRANCH_TYPE:
        description: 'åˆ†æ”¯ç±»å‹'     
        required: false
        default: 'current' 
        type: choice
        options:
        - current
        - edge

#CIæƒé™
permissions: write-all
  
jobs:
  build_armbian_firmware:
    name:  ç¼–è¯‘-${{ github.event.inputs.BRANCH_TYPE }}_${{ matrix.IMAGE_TYPE }}_${{ matrix.RELEASE_type }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        #IMAGE_TYPE: [minimal, cli, desktop]
        IMAGE_TYPE: [minimal, cli]
        RELEASE_type:
          # - focal # Ubuntu 20.04 LTS
          # - jammy # Ubuntu 22.04 LTS
          - noble # Ubuntu 24.04 LTS
          - oracular # Ubuntu 24.10
          - plucky # Ubuntu 25.04
          # - buster # Debian 10
          # - bullseye # Debian 11
          - bookworm # Debian 12
          - trixie # Debian 13
          - sid # Debian unstable
        
    steps:
      - name: æ¸…ç†æœåŠ¡å™¨ç©ºé—´(Ubuntu)
        uses: rmoyulong/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: true

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
            
      - name: æ£€æŸ¥é¡¹ç›®
        uses: actions/checkout@main
 
      - name: æ£€æŸ¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673 \n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡ï¼š$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo -e "CPUæ ¸å¿ƒä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
          echo -e "$(sudo lshw -short -C memory | grep GiB) \n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
    
      - name: ä¸‹è½½æœ€æ–°armbianåº“
        run: |
           git clone --depth=1 --branch=main https://github.com/armbian/build build
           
           TIME="$(curl https://api.github.com/repos/${{ github.repository }}/actions/runs/${GITHUB_RUN_ID} | jq -r .created_at)"
           TAG="ç©å®¢äº‘armbianæœ€æ–°ç‰ˆ-$(date -d "${TIME}" -u +'%Y%m%d-%H%M%S-%Z')"
           export CORE_TAG=${TAG}
           echo "CORE_TAG=$CORE_TAG" >> $GITHUB_ENV
           echo ${TAG}
           
      - name: ç¼–è¯‘
        run: |
          # Don't update remote cache
          export GITHUB_ACTIONS=false
          cd build
          if [[ "${{ matrix.IMAGE_TYPE }}" == "*desktop*" ]]; then
              sudo --preserve-env \
                ./compile.sh build \
                  ALLOW_ROOT=yes \
                  BOARD=onecloud \
                  BRANCH=${{ github.event.inputs.BRANCH_TYPE }} \
                  RELEASE=${{ matrix.RELEASE_type }} \
                  KERNEL_CONFIGURE=no \
                  BUILD_MINIMAL=${{ matrix.IMAGE_TYPE == 'minimal' && 'yes' || 'no' }} \
                  BUILD_DESKTOP=${{ matrix.IMAGE_TYPE == 'desktop' && 'yes' || 'no' }} \
                  DESKTOP_ENVIRONMENT="xfce" \
                  DESKTOP_ENVIRONMENT_CONFIG_NAME="config_base" \
                  DESKTOP_APPGROUPS_SELECTED="" \
                  EXPERT=yes \
                  SKIP_EXTERNAL_TOOLCHAINS=yes \
                  CLEAN_LEVEL= \
                  USE_CCACHE=no \
                  COMPRESS_OUTPUTIMAGE=img
          else
              sudo --preserve-env \
                ./compile.sh build \
                  ALLOW_ROOT=yes \
                  BOARD=onecloud \
                  BRANCH=${{ github.event.inputs.BRANCH_TYPE }} \
                  RELEASE=${{ matrix.RELEASE_type }} \
                  KERNEL_CONFIGURE=no \
                  BUILD_MINIMAL=${{ matrix.IMAGE_TYPE == 'minimal' && 'yes' || 'no' }} \
                  BUILD_DESKTOP=${{ matrix.IMAGE_TYPE == 'desktop' && 'yes' || 'no' }} \
                  DESKTOP_ENVIRONMENT= \
                  DESKTOP_ENVIRONMENT_CONFIG_NAME= \
                  DESKTOP_APPGROUPS_SELECTED= \
                  EXPERT=yes \
                  SKIP_EXTERNAL_TOOLCHAINS=yes \
                  CLEAN_LEVEL= \
                  USE_CCACHE=no \
                  COMPRESS_OUTPUTIMAGE=img
          fi
          

          sudo chown $(id -u):$(id -g) -R output/
          
      - name: å®‰è£…ä¾èµ–é¡¹
        run: |
          sudo apt install android-sdk-libsparse-utils
          ver="v0.3.2"
          curl -L -o ./AmlImg https://github.com/rmoyulong/AmlImg/releases/download/$ver/AmlImg_${ver}_linux_amd64
          chmod +x ./AmlImg

      - name: ä¸‹è½½å¹¶è§£å‹æœ€æ–°çš„ u-boot
        run: |
          echo "::group::Download"
          curl -L -o ./uboot.img https://github.com/rmoyulong/u-boot-onecloud/releases/download/Onecloud_Uboot_23.12.24_18.15.09/eMMC.burn.img
          echo "::endgroup::"
          
          echo "::group::Unpack"
          ./AmlImg unpack ./uboot.img burn/
          echo "::endgroup::"

      - name: æå–bootå’Œrootfsåˆ†åŒº
        run: |
          diskimg=$(ls build/output/images/*.img)
          loop=$(sudo losetup --find --show --partscan $diskimg)
          sudo img2simg ${loop}p1 burn/boot.simg
          sudo img2simg ${loop}p2 burn/rootfs.simg
          sudo losetup -d $loop
          sudo chown $(id -u):$(id -g) -R burn/

      - name: ç”Ÿæˆåˆ»å½•æ˜ åƒ
        run: |
          echo -n "sha1sum $(sha1sum burn/boot.simg | awk '{print $1}')" >burn/boot.VERIFY
          echo -n "sha1sum $(sha1sum burn/rootfs.simg | awk '{print $1}')" >burn/rootfs.VERIFY
          
          cat <<EOF >>burn/commands.txt
          PARTITION:boot:sparse:boot.simg
          VERIFY:boot:normal:boot.VERIFY
          PARTITION:rootfs:sparse:rootfs.simg
          VERIFY:rootfs:normal:rootfs.VERIFY
          EOF
          
          prefix=$(ls build/output/images/*.img | sed 's/\.img$//')
          burnimg=${prefix}.burn.img
          ./AmlImg pack $burnimg burn/

      - name: è¿›è¡Œå“ˆå¸Œå¤„ç†å’Œå‹ç¼©
        run: |
          mkdir -p image_upload
          for f in build/output/images/*.img; do
            xz --threads=0 --compress "$f"
            mv build/output/images/*.xz image_upload
          done
          
      - name: æå–ç‰ˆæœ¬å·
        run: |  
          # æå–ç‰ˆæœ¬å·
          # latest_image=$(ls build/output/images/Armbian-unofficial_*.burn.img.xz | grep -oE 'Armbian-unofficial_[0-9.]+_.*' | sort -V | tail -n 1) 
          latest_image=$(ls build/output/images/Armbian-unofficial_*.burn.img.xz | sort -V | tail -n 1)
          version=$(echo "$latest_image" | cut -d'_' -f 2)  
  
          # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºç¯å¢ƒå˜é‡  
          echo "version=$version" >> $GITHUB_ENV
          
      - name: ç”Ÿæˆæ ‡ç­¾ï¼Œä¸Šä¼ å›ºä»¶
        uses: ncipollo/release-action@main
        with:
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{env.CORE_TAG}}
          artifacts: image_upload/*
          body: | 
            ====================ğŸ§Šå›ºä»¶ä¿¡æ¯ğŸ§Š=======================
            â¦ ğŸ’» å›ºä»¶æºç ï¼šhttps://github.com/armbian/build
            â¦ ğŸ’ æºç åˆ†æ”¯ï¼š${{ github.event.inputs.BRANCH_TYPE }}
            â¦ ğŸš€ ç¼–è¯‘ç‰ˆæœ¬ï¼š${{ env.version }}
            â¦ ğŸŒ é»˜è®¤ç”¨æˆ·ï¼šroot
            â¦ ğŸ”‘ é»˜è®¤å¯†ç ï¼š1234
