name: 玩客云armbain测试脚本
#desktop版本6.12内核只有noble、oracular、plucky、bullseye、bookworm编译成功

on:
  #对应的是 UTC 时间，需要转换，0 代表北京时间8点，每个月1日/15日12点编译一次
  #关闭则手动编译
  workflow_dispatch:
    inputs:
      BRANCH_TYPE:
        description: '分支类型'     
        required: false
        default: 'current' 
        type: choice
        options:
        - current
        - edge

env:
  PATCHES: 4077,5076
  PATCHES_DISABLED: 5082
  BRANCH_TYPE: ${{ github.event.inputs.BRANCH_TYPE }}
  
permissions:
  contents: write
  
jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      TIME: ${{ steps.get.outputs.TIME }}
      TAG: ${{ steps.get.outputs.TAG }}
      CORE_TAG: ${{ steps.get.outputs.CORE_TAG }}
      DOWN_TAG: ${{ steps.get.outputs.DOWN_TAG }}
    steps:
      - id: get
        name: 下载最新armbian库
        run: |
           #git clone --depth=1 --branch=main https://github.com/armbian/build build
           
           TIME="$(curl https://api.github.com/repos/${{ github.repository }}/actions/runs/${GITHUB_RUN_ID} | jq -r .created_at)"
           TAG="玩客云armbian桌面版-$(date -d "${TIME}" -u +'%Y%m%d-%H%M%S-%Z')"
           export CORE_TAG=${TAG}
           
           echo "TIME=$TIME" >> $GITHUB_ENV
           echo "TAG=$TAG" >> $GITHUB_ENV
           echo "CORE_TAG=$CORE_TAG" >> $GITHUB_ENV
           echo "BRANCH_TYPE=${{ env.BRANCH_TYPE }}" >> $GITHUB_ENV
           echo "DOWN_TAG="debs-${{ env.BRANCH_TYPE }}" >> $GITHUB_ENV
           
           echo "TIME=$TIME" >> $GITHUB_OUTPUT
           echo "TAG=$TAG" >> $GITHUB_OUTPUT
           echo "CORE_TAG=$CORE_TAG" >> $GITHUB_OUTPUT
           echo "BRANCH_TYPE=${{ env.BRANCH_TYPE }}" >> $GITHUB_OUTPUT
           echo "DOWN_TAG="debs-${{ env.BRANCH_TYPE }}" >> $GITHUB_OUTPUT
           
  build_armbian_firmware:
    name:  编译-${{ matrix.TYPE }}_${{ matrix.RELEASE }}
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        RELEASE:
          # - focal # Ubuntu 20.04 LTS
          # - jammy # Ubuntu 22.04 LTS
          # - noble # Ubuntu 24.04 LTS
          - oracular # Ubuntu 24.10
          #- plucky # Ubuntu 25.04
          # - buster # Debian 10
          #- bullseye # Debian 11
          - bookworm # Debian 12
          # - trixie # Debian 13
          # - sid # Debian unstable
        TYPE:
          #- minimal
          #- cli
          - desktop      
        
    steps:
      - name: 获得环境变量
        run: |
          echo "$( echo ${{ needs.prepare.outputs.DOWN_TAG }} )" >>$GITHUB_ENV
          echo "$( echo ${{ needs.prepare.outputs.CORE_TAG }} )" >>$GITHUB_ENV
          echo "$( echo ${{ needs.prepare.outputs.BRANCH_TYPE }} )" >>$GITHUB_ENV
          echo "$( echo ${{ needs.prepare.outputs.TIME }} )" >>$GITHUB_ENV
          echo "$( echo ${{ needs.prepare.outputs.TAG }} )" >>$GITHUB_ENV
          
          echo "1:DOWN_TAG" 
          echo ${{ env.DOWN_TAG }}
          echo "2:CORE_TAG" 
          echo ${{ env.CORE_TAG }}
          echo "3:BRANCH_TYPE" 
          echo ${{ env.BRANCH_TYPE }}